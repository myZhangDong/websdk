# 集成文档

[简介|功能说明|接入]

**多人音视频Web SDK**是以Websocket为通讯基础，WebRTC为协议，支持多种浏览器 即时多媒体通话功能。通过SDK可快速完成即时视频通话功能。特点概述：

- **浏览器支持** ：Chrome/50, Safari/11, Edge, Firefox；
- **功能** ：视频通话，音频通话，远程抓拍，远程聚焦、镜头缩放；桌面共享（仅支持Chrome浏览器）；
- **实现** ：H5，原生JS, 支持require；
- **限制** ：https

-------------------

# 接入

下载**EMedia_sdk-2.0.1.js**。可通过添加script标签引用。或 var emedia = require("./EMedia_sdk-2.0.1.js")

# 集成
```javascript
<script src="./webrtc/dist/EMedia_sdk-dev.js"></script>
或
var emedia = require("./EMedia_sdk-2.0.1.js")
```
# SDK回调
1.有人加入会议，其他人调用joinXX等方法，如果加入成功，已经在会议中的人将会收到
```javascript
emedia.mgr.onMemberJoined = function (member) {
    
};
```
2.有人退出会议
```javascript
emedia.mgr.onMemberExited = function (member) {
    
};
```
3.有媒体流添加；比如 自己调用了publish方法（stream.located() === true时），或其他人调用了publish方法。
```javascript
emedia.mgr.onStreamAdded = function (member, stream) {

};
```
4.有媒体流移除；
```javascript
emedia.mgr.onStreamRemoved = function (member, stream) {

};
```
5.角色改变；
```javascript
emedia.mgr.onRoleChanged = function (role) {

};
```
6.会议退出；自己主动退出，服务端主动关闭；
```javascript
emedia.mgr.onConferenceExit = function (reason, failed) {
    reason = (reason || 0);
    switch (reason){
        case 0:
            reason = "正常挂断";
            break;
        case 1:
            reason = "没响应";
            break;
        case 2:
            reason = "服务器拒绝";
            break;
        case 3:
            reason = "对方忙";
            break;
        case 4:
            reason = "失败,可能是网络或服务器拒绝";
            if(failed === -9527){
                reason = "失败,网络原因";
            }
            if(failed === -500){
                reason = "Ticket失效";
            }
            if(failed === -502){
                reason = "Ticket过期";
            }
            if(failed === -504){
                reason = "链接已失效";
            }
            if(failed === -508){
                reason = "会议无效";
            }
            if(failed === -510){
                reason = "服务端限制";
            }
            break;
        case 5:
            reason = "不支持";
            break;
        case 10:
            reason = "其他设备登录";
            break;
        case 11:
            reason = "会议关闭";
            break;
    }
};
```

# 接口说明

1.常量
```javascript
emedia.mgr.ConfrType = {
   COMMUNICATION: 10, //普通会议模式
   COMMUNICATION_MIX: 11, //大会议模式
   LIVE: 12, //直播模式
};

emedia.mgr.Role = {
    ADMIN: 7, //管理员(可推送视频、可解散会议、可踢人、可变更其他人角色，会议创建者默认为管理员)
    TALKER: 3, // 主播（可发言、可观看）
    AUDIENCE: 1 // 观众（仅可以观看）
};
```

2.conference|confr
```javascript
{
    confrId:"TS_X296786295944036352C27",
    id:"TS_X296786295944036352C27",
    password: "password123", 
    roleToken:"roleToken",
    ticket:"ticket",
    type:12
}
```
3.member
```javascript
{
    "ext":{ //emedia.mgr.joinConference(confrId, password, {role: 'admin'})/* 用户可自定义扩展字段*/);
        "role":"admin"
    },
    "id":"MS_X197721744293023744C19M197756407719972865VISITOR",
    "globalName":"easemob-demo#chatdemoui_yss000@easemob.com",
    "name": "yss000"
}
```
4.stream
```javascript
{
    
    "id":"RTC2__Of_C19M197756407719972865VISITOR",
    "voff":0, //1 视频关闭 
    "aoff":0, //1 音频关闭 
    "memId":"MS_X197721744293023744C19M197756407719972865VISITOR",
    "owner": member ,//member对象
    "rtcId":"RTC1"
}

var islocated = stream.located(); //islocated true 本地媒体流
```

5.创建会议
```javascript
emedia.mgr.createConference(confrType, password).then(function(confr){
    //confr 即为创建的会议
}).catch(function(error){

})
```
6.获取加入会议ticket
```javascript
emedia.mgr.getConferenceTkt(confrType, password).then(function(confr){
    
}).catch(function(error){

})
```
7.销毁会议
```javascript
emedia.mgr.destroyConference(confr).then(function(){
    
}).catch(function(error){

})
```
8.踢人
```javascript
emedia.mgr.kickMembersById(confr, memberNames).then(function(){
    
}).catch(function(error){

})
```
9.授权
```javascript
emedia.mgr.grantRole(confr, memberNames, role).then(function(){
    
}).catch(function(error){

})
```

10.使用用户名密码加入会议，可自定义ext，其他会议成员将会看到
```javascript
emedia.mgr.joinConference(confrId, password, ext).then(function(){
    
}).catch(function(error){

})
```
11.使用ticket加入会议，可自定义ext，其他会议成员将会看到
```javascript
emedia.mgr.joinConference(confrId, ticket, ext).then(function(){
    
}).catch(function(error){

})
```
12.退出会议
```javascript
emedia.mgr.exitConference();
```
13.publish 媒体流
```javascript
/**
 * constaints： {audio: true, video: true}
 * videoTag 可缺失，如果有 此次publish的媒体数据将会在这个video上显示 将会与stream绑定
 * ext 用户自定义扩展，其他成员可以看到这个字段
 * 
 */
emedia.mgr.publish(constaints, videoTag, ext).then(function(pushedStream){
    //stream 对象
}).catch(function(error){

});

/**
 * videoTag 可缺失时
 *
 */
emedia.mgr.publish(constaints, ext).then(function(pushedStream){
    //stream 对象
    //如果需要将这个stream对象 显示，需要 emedia.mgr.streamBindVideo(videoTag, pushedStream)
}).catch(function(error){

});
```
14.共享桌面 目前仅支持Pc chrome 或 electron平台
```javascript
/**
 * videoConstaints {screenOptions: ['screen', 'window', 'tab']} or true
 * withAudio： true 携带语音，false不携带
 * videoTag 可缺失，如果有 此次publish的媒体数据将会在这个video上显示 将会与stream绑定
 * ext 用户自定义扩展，其他成员可以看到这个字段
 * 
 */
emedia.mgr.shareDesktopWithAudio(videoConstaints, withAudio, videoTag, ext).then(function(pushedStream){
    //stream 对象
}).catch(function(error){

});

//electron平台 默认选择第一个屏幕，如果需要选择其他，需要重写方法
emedia.chooseElectronDesktopMedia = function(sources, accessApproved){
    var firstSources = sources[0];
    accessApproved(firstSources);
}
```
15.取消publish
```javascript
emedia.mgr.unpublish(pushedStream);
或
emedia.mgr.hungup(pushedStream);
```

16.订阅
```javascript
/**
 * subSVideo 看视频
 * subSAudio 看音频
 * videoTag 可缺失，如果有 将会与stream绑定，并播放stream
 */
emedia.mgr.subscribe(member, stream, subSVideo, subSAudio, videoTag).then(function(){
    //stream 对象
}).catch(function(error){

});
emedia.mgr.triggerSubscribe(videoTag, subSVideo, subSAudio).then(function(){
    //stream 对象
}).catch(function(error){

});
也可以
//仅订阅音频
emedia.mgr.triggerResumeAudio(videoTag).then(function(){
}).catch(function(error){
});
//仅暂停订阅音频
emedia.mgr.triggerPauseAudio(videoTag).then(function(){
}).catch(function(error){
});

//仅订阅视频
emedia.mgr.triggerResumeVideo(videoTag).then(function(){
}).catch(function(error){
});
//仅暂停订阅视频
emedia.mgr.triggerPauseVideo(videoTag).then(function(){
}).catch(function(error){
});

```
17.取消订阅
```javascript
emedia.mgr.unsubscribe(stream);
或
emedia.mgr.hungup(stream);
```
18.stream video 绑定。stream 与 video绑定后，video才可以播放stream；并且可以通过触发/监听video上的事件，来达到对stream的便捷操作
```javascript
emedia.mgr.streamBindVideo(stream, videoTag);
```
19.获取stream绑定的video
```javascript
emedia.mgr.getBindVideoBy(stream);
```
20.切换摄像头
```javascript
emedia.mgr.switchCamera().then(function(){

}).catch(function(){

})
```
21.暂停/恢复 自己的视频
```javascript
emedia.mgr.pauseVideo(pubS).then(function(){

}).catch(function(){

})
等价于
emedia.mgr.triggerResumeVideo(localVideoTag).then(function(){

}).catch(function(){

})
```
```javascript
emedia.mgr.pauseVideo(pubS).then(function(){

}).catch(function(){

})
等价于
emedia.mgr.triggerPauseVideo(localVideoTag).then(function(){

}).catch(function(){

})
```
22.抓取 video图像，并保存
```javascript
emedia.mgr.captureVideo(videoTag, true, filename)
等价于
emedia.mgr.triggerCaptureVideo(videoTag, true, filename);
```
23.使远程视频定格 仅支持手机端sdk
```javascript
emedia.mgr.freezeFrameRemote(stream);
等价于
emedia.mgr.triggerFreezeFrameRemote(videoTag).catch(function(){
    alert("定格失败");
});
```
24.使手机闪光灯打开 关闭 仅支持手机端sdk
```javascript
/**
 * torch true 打开，否则 关闭; 可缺失
 */
emedia.mgr.torchRemote(stream， torch);
等价于
emedia.mgr.triggerTorchRemote(videoTag, torch).catch(function(){
    alert("Torch失败");
});
```
25.控制手机截屏 仅支持手机端sdk
```javascript
emedia.mgr.capturePictureRemote(stream);
等价于
emedia.mgr.triggerCapturePictureRemote(videoTag).catch(function(){
    alert("抓图失败");
});
```
26.控制手机摄像头 放大缩小，仅支持手机端sdk
```javascript
emedia.mgr.zoomRemote(stream, multiples);
等价于
emedia.mgr.triggerZoomRemote(videoTag, multiples).catch(function(){
    alert("zoom失败");
});
```
27.控制手机摄像头聚焦 曝光，仅支持手机端sdk
```javascript
/**
 * clickEvent 为 videoTag的点击事件。通过event计算点击的坐标传给sdk进行控制
 *
 */
emedia.mgr.focusExpoRemote(stream, videoTag, clickEvent).catch(function(){
    alert("focusExpoRemote失败");
});
等价于
/**
 * event string. 如点击 “click”
 * fail 失败回调；success成功回调
 */
emedia.mgr.onFocusExpoRemoteWhenClickVideo(videoTag, event, fail, success);
```

28.取消在videoTag上的事件，用来 对onFocusExpoRemoteWhenClickVideo的撤销
```javascript
emedia.mgr.offEventAtTag(videoTag);
```

29.将video标签上的鼠标活动及键盘操作 传输到 stream的发布方。例如远程控制的控制端
```javascript
/**
 * 向stream的发起方，发起
 * mirror：video 是否镜像
 * 以下回调，可以乱序，可以缺失，但是函数名要一致
 * onDisControlled： 控制端开，名字不能更改
 * onAccept：控制接受
 * onNotAllowRemoteControl：对方不支持袁成功控制
 * onRemoteControlTimeout：远程控制超时
 * onReject：被拒绝
 * onBusy：对方忙
 *
 */
emedia.mgr.remoteControl(stream, videoTag, videoTag, mirror,
    onDisControlled, onAccept, onNotAllowRemoteControl, onRemoteControlTimeout, onReject, onBusy);
等价于
emedia.mgr.triggerRemoteControl(videoTag, mirror,
    onDisControlled, onAccept, onNotAllowRemoteControl, onRemoteControlTimeout, onReject, onBusy);
```

30.控制方释放远程控制
```javascript
emedia.mgr.freeRemoteControl(stream);
等价于
emedia.mgr.triggerFreeRemoteControl(videoTag);
```
31.video监听的事件
```javascript
//video的音频视频开关，将会触发
emedia.mgr.onMediaChanaged(videoTag, function (constaints) {
    $div.find("#aoff").html(constaints.audio ? "有声" : "无声");
    $div.find("#voff").html(constaints.video ? "有像" : "无像");

    //可以通过video标签 得知发布方 是否关闭 音频 视频
    console.warn($(videoTag).attr("easemob_stream"), "aoff", $(videoTag).attr("aoff"));
    console.warn($(videoTag).attr("easemob_stream"), "voff", $(videoTag).attr("voff"));
});
```
```javascript
//video的声音大小出发，比如谁在说话
emedia.mgr.onSoundChanaged(videoTag,, function (meterData) {
    var $volume = $div.find('#volume');

    $volume.html(meterData.instant.toFixed(2)
        + " " + meterData.slow.toFixed(2)
        + " " + meterData.clip.toFixed(2)
        + " " + (meterData.trackAudioLevel ? parseFloat(meterData.trackAudioLevel).toFixed(4) : "--")
        + " " + (meterData.trackTotalAudioEnergy ? parseFloat(meterData.trackAudioLevel).toFixed(4) : "--")
    );
});
```
```javascript
//视频收发数据统计
emedia.mgr.onMediaTransmission(videoTag, function notify(trackId, type, subtype, data) {
    var $iceStatsShow = $div.find("#iceStatsShow");
    var $em = $iceStatsShow.find("#"+subtype);
    if(!$em.length){
        $em  = $("<em></em>").appendTo($iceStatsShow).attr("id", subtype);
    }

    $em.text(subtype + ":" + (data*8/1000).toFixed(2));
});
```
```javascript
//连接状态变化
emedia.mgr.onIceStateChanged(videoTag, function (state) {
    console.log(state);
});
```
```javascript
//控制端 释放了远程控制
emedia.mgr.onRemoteFreeControl = function onRemoteFreeControl(stream, controler, cId){
}
或
emedia.mgr.onFreeControl(videoTag, function (controler, cId, stream) {
    alert("<" + controler.memName + ">对流:" + stream.id + "控制 释放");
});
```
```javascript
/**
 * 如果在videoTag上有远程控制
 */
emedia.mgr.onRemoteControl(videoTag, function (controler, controlRequest, stream) {
}
如果onHasRemoteControl被重写上述将失效
emedia.mgr.onHasRemoteControl = function onHasRemoteControl(stream, controler, controlRequest, confrId) {
    var rtn = confirm("同意 来自<" + controler.memName + ">对流:" + stream.id + "控制申请吗？");
    if(rtn){
        var htmlId = stream.getHtmlDOMID();
        var $div = $('#' + htmlId);

        var $video = $div.find("#videoTag");
        var $videoTrack = $div.find("#video_box #track");
        var $canvas = $div.find("#video_box canvas");

        $videoTrack.show();
        $canvas.show();

        var MouseTrack = emedia.pannel.MouseTrack.extend({
            onMouseTrack: function (position, lastPosition, lastTrigger) {
                console.log("Mouse move", position);
            },
            onMouseTrigger: function (trigger, _lastTrigger) {
                console.log("OK?", trigger);
            },
            onReleaseTrigger: function (_lastTrigger) {
            }
        });
        var KeyboardTrack = emedia.pannel.KeyboardTrack.extend({
            onKeyDown: function (btn) {
                console.log("Down ", btn);
            },

            onKeyUp: function (btn) {
                console.log("Up ", btn);
            }
        });
        controlRequest.accept(new MouseTrack(), new KeyboardTrack()); //同意
        //controlRequest.forceDisconnect() //控制过程中强制断开
    }else{
        controlRequest.reject(); //拒绝
    }
}
```

# Demo
## 发起会议
### 1.调用 createConference，再回调中可以得到confr对象；创建者默认为管理员
```javascript
emedia.mgr.createConference(confrType, password).then(function(confr){
    //confr 即为创建的会议
    //将ID password 发送给其他人
}).catch(function(error){

})
```
### 2.加入会议
```javascript
emedia.mgr.joinConference(confrId, ticket, ext).then(function(confr){
    //confr 即为创建的会议
}).catch(function(error){

})
```
### 3.发布本地媒体数据 如麦克风、摄像头；会导致sdk会调用emedia.mgr.onStreamAdded(member, stream)
```javascript
emedia.mgr.publish(constaints, videoTag, ext).then(function(pushedStream){
    //stream 对象
}).catch(function(error){

});
```
### 4.sdk调用emedia.mgr.onMemberJoin(member, stream) 告知进入的人
### 5.sdk调用emedia.mgr.onStreamAdded(member, stream) 告知进入的人发布的流情况
### 6.可根据需要进行订阅emedia.mgr.subscribemember, stream, subSVideo, subSAudio, videoTag)
### 7.onMemberExited:当有人离开会议，onRoleChanged自己在会议中角色改变；onStreamRemoved某人取消流发布；onConferenceExit会议退出

## 其他人进入会议
### 1.调用 joinConference，再回调中可以得到confr对象；创建者默认为管理员
```javascript
emedia.mgr.joinConference(confr, password, ext).then(function(confr){
    //confr 加入会议
}).catch(function(error){

})
```
### 2.sdk调用emedia.mgr.onMemberJoin(member, stream) 告知进入的人
### 3.sdk调用emedia.mgr.onStreamAdded(member, stream) 告知进入的人发布的流情况
### 4.可根据需要进行订阅emedia.mgr.subscribemember, stream, subSVideo, subSAudio, videoTag)
### 5.onMemberExited:当有人离开会议，onRoleChanged自己在会议中角色改变；onStreamRemoved某人取消流发布；onConferenceExit会议退出
